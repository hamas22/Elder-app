<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>الملاحظات الصوتية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

        body {
            font-family: 'Cairo', sans-serif;
            background-attachment: fixed;
            min-height: 100vh;
        }

        .record-btn {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .recording {
            animation: pulse-record 1.5s infinite ease-in-out;
        }

        @keyframes pulse-record {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(255, 0, 0, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 25px rgba(255, 0, 0, 0.6);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(255, 0, 0, 0.4);
            }
        }

        .note-item {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .return-button {
            background-color: transparent;
            border: 2px solid rgba(255, 255, 255, 0.8);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .return-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-200 to-blue-400 p-8">

    <a href="elder-home.html" class="absolute top-5 right-5 z-10">
        <button class="return-button" aria-label="العودة إلى الصفحة الرئيسية">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right">
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
        </button>
    </a>

    <div class="max-w-2xl mx-auto backdrop-blur-lg bg-white/30 rounded-3xl shadow-xl p-8 md:p-12">
        <h1 class="text-4xl md:text-5xl font-bold text-center text-gray-800 mb-8 mt-4">
            الملاحظات الصوتية 🎤
        </h1>

        <button id="recordBtn" class="record-btn w-full md:w-auto px-12 py-5 text-xl font-bold rounded-full text-white bg-blue-600 hover:bg-blue-700 mx-auto block mb-8">
            بدء التسجيل
        </button>

        <p id="infoMsg" class="text-center text-lg text-gray-700 font-semibold mb-6"></p>

        <ul id="notesList" class="space-y-4"></ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCBfkZJ8uto9wZ-N4_RdFvRtUhhnfwvBbk",
            authDomain: "elder-app-26500.firebaseapp.com",
            projectId: "elder-app-26500",
            storageBucket: "elder-app-26500.appspot.com",
            messagingSenderId: "104692158450",
            appId: "1:104692158450:web:4c368876ebc9f43e42656b",
            measurementId: "G-WHQRY7EGZW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const recordBtn = document.getElementById('recordBtn');
        const notesList = document.getElementById('notesList');
        const infoMsg = document.getElementById('infoMsg');

        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        const elderPhone = localStorage.getItem('elderID');

        if (!elderPhone) {
            alert("يرجى تسجيل الدخول كمُسن أولاً.");
            window.location.href = 'elder-login.html';
        }

        async function loadNotes() {
            notesList.innerHTML = '';
            infoMsg.textContent = 'جاري تحميل الملاحظات...';

            try {
                const voiceNotesRef = collection(db, "voiceNotes");
                const q = query(voiceNotesRef, where("elderPhone", "==", elderPhone));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    infoMsg.textContent = 'لم يتم العثور على ملاحظات صوتية. ابدأ بالتسجيل!';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const noteData = doc.data();
                    const noteId = doc.id;
                    addNoteToList(noteData.audioUrl, noteData.label, noteId);
                });

                infoMsg.textContent = '';
            } catch (e) {
                console.error("خطأ في تحميل الملاحظات: ", e);
                infoMsg.textContent = 'حدث خطأ أثناء تحميل الملاحظات.';
            }
        }

        function addNoteToList(audioUrl, label, docId) {
            const li = document.createElement('li');
            li.classList.add('note-item', 'bg-white/70', 'p-4', 'rounded-xl', 'shadow-md', 'flex', 'items-center', 'justify-between', 'hover:bg-white/90', 'transition-colors');

            const span = document.createElement('span');
            span.className = 'note-label text-gray-800 font-semibold truncate ml-4';
            span.textContent = label;

            const audio = document.createElement('audio');
            audio.controls = true;
            audio.src = audioUrl;
            audio.classList.add('w-full', 'max-w-[200px]', 'md:max-w-xs', 'mx-4');

            const delBtn = document.createElement('button');
            delBtn.className = 'delete-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors flex items-center justify-center';
            delBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            `;
            delBtn.onclick = async () => {
                if (confirm(`هل أنت متأكد من حذف "${label}"؟`)) {
                    try {
                        await deleteDoc(doc(db, "voiceNotes", docId));
                        li.remove();
                        infoMsg.textContent = `تم حذف "${label}" بنجاح.`;
                        setTimeout(() => infoMsg.textContent = '', 2500);
                    } catch (e) {
                        console.error("خطأ في حذف المستند: ", e);
                        alert("حدث خطأ أثناء حذف الملاحظة.");
                    }
                }
            };

            li.appendChild(span);
            li.appendChild(audio);
            li.appendChild(delBtn);

            notesList.appendChild(li);
        }

        async function saveNoteToFirestore(audioBlob) {
            try {
                // In a real application, you would upload the Blob to Firebase Storage
                // and then save the download URL to Firestore. For this demo, we'll
                // just show that the save process is complete.
                const label = `ملاحظة - ${new Date().toLocaleString('ar-SA')}`;
                
                await addDoc(collection(db, "voiceNotes"), {
                    elderPhone: elderPhone,
                    audioUrl: 'data:audio/mp3;base64,' + await blobToBase64(audioBlob), // Using Base64 for the demo, not recommended for production
                    label: label,
                    createdAt: new Date()
                });
                
                loadNotes();
                infoMsg.textContent = `تم حفظ "${label}" بنجاح!`;
                setTimeout(() => infoMsg.textContent = '', 3000);
            } catch (e) {
                console.error("خطأ في إضافة المستند: ", e);
                alert("حدث خطأ أثناء حفظ الملاحظة.");
            }
        }

        const blobToBase64 = (blob) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });
        };

        async function startRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('متصفحك لا يدعم تسجيل الصوت.');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                isRecording = true;
                recordBtn.textContent = 'إيقاف التسجيل';
                recordBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'recording');
                recordBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                audioChunks = [];
                mediaRecorder.ondataavailable = e => {
                    audioChunks.push(e.data);
                };
                mediaRecorder.onstop = e => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                    saveNoteToFirestore(audioBlob);
                    isRecording = false;
                    recordBtn.textContent = 'بدء التسجيل';
                    recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'recording');
                    recordBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                };
            } catch (err) {
                alert('تم رفض الإذن أو حدث خطأ أثناء الوصول إلى الميكروفون.');
            }
        }

        function stopRecording() {
            mediaRecorder.stop();
        }

        recordBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        window.onload = loadNotes;
    </script>
</body>
</html>